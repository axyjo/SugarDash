<!DOCTYPE html>  <html> <head>   <title>timezone.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               timezone.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Some local times do not exist, like when clocks are set forward for daylight
savings time.</p>

<h3>Before You Can Read This Code</h3>

<p>The <code>wallclock</code> variable mentioned throughout the code is always a seconds
since the epoch offset, but it is <em>not</em> UTC seconds since the epoch. When you
see a <code>utc</code> variable, that is always seconds since the epoch, always in UTC.</p>

<p>When you see a <code>date</code> variable we're using a <code>Date</code> object for its its
<code>getUTC*</code> fields.  We use a <code>Date</code> object as a date/time record, and the
<code>Date</code> object's <code>getUTC*</code> methods as date/time fields. We use this structure
as a time record, but the <code>getUTC*</code> values are always going represent values
in the user specified time zone, the <code>wallclock</code> time. This time could be UTC,
but only if that is what the user wants.</p>

<p>Why do we do this? Because <code>Date</code> is a built-in and compact representation of
date and time. The <code>Date</code> object has some nice properties that makes it easy
to do date math at the year, month and day level. It can calculate the day of
the year. It knows how to calculate the day of the week. It knows about leap
years.</p>

<p>Why don't we use <code>get*</code> instead of <code>getUTC*</code>? The <code>get*</code> methods return the
time adjusted by the current zone offset of the host machine. This zone offset
cannot be set programatically. (If that were the case, this library would
be happily based on the <code>Date</code> object.) The <code>get*</code> methods are not useful to
us because they are adjusted only a zone offset, one that we cannot set, not
by the rules of a time zone, which accounts for daylight savings time and the
whims of the polity.</p>

<p>That <code>Date</code> is broken is the premise of this library, yet <code>Date</code> is a little
workhouse throughout it. </p>

<h3>Also Know That</h3>

<p>The <code>wallclock</code> seconds since the epoch value does not leak out to the user.
The user will only ever get either UTC seconds since the epoch, or a formatted
date string in the user specified time zone.</p>

<p>When you see <code>utc</code> in the code, we've converted the <code>wallclock</code> to UTC to
perform math at the hours, minutes, seconds, and milliscond level. We convert
the time <code>wallclock</code> to UTC to perform the math, and then convert back into
the <code>wallclock</code> into the user specified time zone. Thus, daylight savings time
shifts are not lost.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Wrap everything in a function and pass in an exports map appropriate for node
or the browser, depending on where we are.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">do</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">exports</span> <span class="o">or=</span> <span class="nb">window</span><span class="p">)</span> <span class="o">and</span> <span class="nx">do</span> <span class="nf">(exports) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Locales and time zones are global, because they are, literally, global.</p>

<p>We provide UTC.</p>

<p>We provide a default locale for the United States. Currently, locales are
simply JSON structures, but in the future they may contain logic for locale
specific fuzzy date parsing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">TIMEZONES =</span>
    <span class="nv">zones:</span>
      <span class="nv">UTC: </span><span class="p">[</span> <span class="p">{</span> <span class="s2">&quot;offset&quot;</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="o">:</span> <span class="s2">&quot;UTC&quot;</span> <span class="p">}</span> <span class="p">]</span>
    <span class="nv">rules: </span><span class="p">{}</span>
  <span class="nv">TIMEZONES.zones.UTC.name = </span><span class="s2">&quot;UTC&quot;</span>

  <span class="nv">LOCALES =</span>
    <span class="nv">en_US:</span>
      <span class="nv">name: </span><span class="s2">&quot;en_US&quot;</span>
      <span class="nv">day:</span>
        <span class="nv">abbrev: </span><span class="s2">&quot;Sun Mon Tue Wed Thu Fri Sat&quot;</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\s/</span>
        <span class="nv">full: </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          Sunday Monday Tuesday Wednesday Thursday Friday Saturday</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\s+/</span>
      <span class="nv">month:</span>
        <span class="nv">abbrev: </span><span class="s2">&quot;Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec&quot;</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\s+/</span>
        <span class="nv">full: </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          January February March</span>
<span class="s2">          April   May      June</span>
<span class="s2">          July    August   September</span>
<span class="s2">          October November December</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\s+/</span>
      <span class="nv">dateFormat: </span><span class="s2">&quot;%m/%d/%y&quot;</span>
      <span class="nv">timeFormat: </span><span class="s2">&quot;%H:%M:%S&quot;</span>
      <span class="nv">dateTimeFormat: </span><span class="s2">&quot;%a %b %_d %H:%M:%S %Y&quot;</span>
      <span class="nv">meridiem: </span><span class="p">[</span> <span class="s2">&quot;am&quot;</span><span class="p">,</span> <span class="s2">&quot;pm&quot;</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Constants for units of time in milliseconds.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">SECOND  = </span><span class="mi">1000</span>
  <span class="nv">MINUTE  = </span><span class="nx">SECOND</span> <span class="o">*</span> <span class="mi">60</span>
  <span class="nv">HOUR    = </span><span class="nx">MINUTE</span> <span class="o">*</span> <span class="mi">60</span>
  <span class="nv">DAY     = </span><span class="nx">HOUR</span>   <span class="o">*</span> <span class="mi">24</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h4>isLeapYear(year)</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Return true if the given year is a leap year.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isLeapYear = </span><span class="nf">(year) -&gt;</span>
    <span class="k">if</span> <span class="nx">year</span> <span class="o">%</span> <span class="mi">400</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="kc">true</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">year</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="kc">false</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">year</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="kc">true</span>
    <span class="k">else</span>
      <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h4>daysInMonth(month, year)</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Return the numbers of days in the month for the given zero-indexed month in
the given year.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">daysInMonth = </span><span class="nx">do</span> <span class="o">-&gt;</span>
    <span class="nv">DAYS_IN_MONTH = </span><span class="p">[</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span> <span class="p">]</span>

    <span class="nf">(month, year)-&gt;</span>
      <span class="nv">days = </span><span class="nx">DAYS_IN_MONTH</span><span class="p">[</span><span class="nx">month</span><span class="p">]</span>
      <span class="nx">days</span><span class="o">++</span> <span class="k">if</span> <span class="nx">month</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">isLeapYear</span> <span class="nx">year</span>
      <span class="nx">days</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h4>format(wallclock, request)</h4>

<p>Formats our time <code>wallclock</code> using a UNIX date format. The <code>wallclock</code>
contains the field values for a valid time in the user specified time zone.
Invalid dates would already have been caught by <code>parse</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>We wrap up a great many helpers with this method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">format = </span><span class="nx">do</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The day of the year for the first day of the month for each month.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MONTH_DAY_OF_YEAR = </span><span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">335</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><em>weekOfYear(date, startOfWeek)</em></p>

<p>Get the week of the year for the given <code>date</code>, where <code>startOfWeek</code> is the
week day on which our week starts.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">weekOfYear = </span><span class="nf">(date, startOfWeek) -&gt;</span>
      <span class="nv">fields = </span><span class="p">[</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span> <span class="p">]</span>
      <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span>
      <span class="nv">nyd = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
      <span class="nv">diff = </span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">nyd</span><span class="p">.</span><span class="nx">getTime</span><span class="p">())</span> <span class="o">/</span> <span class="nx">DAY</span>
      <span class="nv">day = </span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">nyd</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()</span> <span class="o">is</span> <span class="nx">startOfWeek</span>
        <span class="nv">weekStart = </span><span class="mi">0</span>
      <span class="k">else</span>
        <span class="nv">weekStart = </span><span class="mi">7</span> <span class="o">-</span> <span class="nx">nyd</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()</span> <span class="o">+</span> <span class="nx">startOfWeek</span>
        <span class="nv">weekStart = </span><span class="mi">1</span> <span class="k">if</span> <span class="nx">weekStart</span> <span class="o">is</span> <span class="mi">8</span>
      <span class="nv">remaining = </span><span class="nx">diff</span> <span class="o">-</span> <span class="nx">weekStart</span>
      <span class="nv">week = </span><span class="mi">0</span>
      <span class="k">if</span> <span class="nx">diff</span> <span class="o">&gt;=</span> <span class="nx">weekStart</span>
        <span class="nx">week</span><span class="o">++</span>
        <span class="nx">diff</span> <span class="o">-=</span> <span class="nx">weekStart</span>
        <span class="nx">week</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">diff</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>
      <span class="nx">week</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><em>isoWeek(date)</em></p>

<p>Get the <a href="http://en.wikipedia.org/wiki/ISO_week_date">ISO week</a> of the year
for the given <code>date</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">isoWeek = </span><span class="nf">(date) -&gt;</span>
      <span class="nv">nyy = </span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span>
      <span class="nv">nyd = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="nx">nyy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="nx">getUTCDay</span><span class="p">()</span>
      <span class="nv">offset = </span><span class="k">if</span> <span class="nx">nyd</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">nyd</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
      <span class="nv">week = </span><span class="nx">weekOfYear</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">offset</span>
      <span class="k">if</span> <span class="nx">week</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nv">ny = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="nv">nyd = </span><span class="nx">ny</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()</span>
        <span class="nv">nyy = </span><span class="nx">ny</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span>
        <span class="nv">week = </span><span class="k">if</span> <span class="nx">nyd</span> <span class="o">is</span> <span class="mi">4</span> <span class="o">or</span> <span class="p">(</span><span class="nx">nyd</span> <span class="o">is</span> <span class="mi">3</span> <span class="o">and</span> <span class="nx">isLeapYear</span><span class="p">(</span><span class="nx">nyy</span><span class="p">))</span> <span class="k">then</span> <span class="mi">53</span> <span class="k">else</span> <span class="mi">52</span>
        <span class="p">[</span> <span class="nx">week</span><span class="p">,</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">week</span> <span class="o">is</span> <span class="mi">53</span> <span class="o">and</span> <span class="o">not</span> <span class="p">(</span><span class="nx">nyd</span> <span class="o">is</span> <span class="mi">4</span> <span class="o">or</span> <span class="p">(</span><span class="nx">nyd</span> <span class="o">is</span> <span class="mi">3</span> <span class="o">and</span> <span class="nx">isLeapYear</span><span class="p">(</span><span class="nx">nyy</span><span class="p">)))</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span>
      <span class="k">else</span>
        <span class="p">[</span> <span class="nx">week</span><span class="p">,</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><em>dialHours(date)</em></p>

<p>Get the hour for a 12 hour clock for the given <code>date</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">dialHours = </span><span class="nf">(date) -&gt;</span>
      <span class="nv">hours = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">()</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">hours</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">12</span> <span class="k">else</span> <span class="nx">hours</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Map the specifiers to a function that implements the specifier. Rather
than document each one, please use a <a href="http://en.wikipedia.org/wiki/Date_%28Unix%29">Unix
Date</a> pattern reference if
you can't deduce the intent from the function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">specifiers =</span>
      <span class="nv">a: </span><span class="nf">(date, locale) -&gt;</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">day</span><span class="p">.</span><span class="nx">abbrev</span><span class="p">[</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()]</span>
      <span class="nv">A: </span><span class="nf">(date, locale) -&gt;</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">day</span><span class="p">.</span><span class="nx">full</span><span class="p">[</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()]</span>
      <span class="nv">d: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span>
      <span class="nv">e: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span>
      <span class="nv">j: </span><span class="nf">(date) -&gt;</span>
        <span class="nv">month = </span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()</span>
        <span class="nv">days = </span><span class="nx">MONTH_DAY_OF_YEAR</span><span class="p">[</span><span class="nx">month</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">month</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">and</span> <span class="nx">isLeapYear</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">())</span>
          <span class="nx">days</span><span class="o">++</span>
        <span class="nx">days</span> <span class="o">+=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nx">days</span>
      <span class="nv">u: </span><span class="nf">(date) -&gt;</span>
        <span class="nv">day = </span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()</span>
        <span class="nv">day = </span><span class="mi">7</span> <span class="k">if</span> <span class="nx">day</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nx">day</span>
      <span class="nv">w: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()</span>
      <span class="nv">U: </span><span class="nf">(date) -&gt;</span> <span class="nx">weekOfYear</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="nv">W: </span><span class="nf">(date) -&gt;</span> <span class="nx">weekOfYear</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nv">V: </span><span class="nf">(date) -&gt;</span> <span class="nv">iso = </span><span class="nx">isoWeek</span><span class="p">(</span><span class="nx">date</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">G: </span><span class="nf">(date) -&gt;</span> <span class="nv">iso = </span><span class="nx">isoWeek</span><span class="p">(</span><span class="nx">date</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">g: </span><span class="nf">(date) -&gt;</span> <span class="nv">iso = </span><span class="nx">isoWeek</span><span class="p">(</span><span class="nx">date</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">100</span>
      <span class="nv">m: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="nv">h: </span><span class="nf">(date, locale) -&gt;</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">month</span><span class="p">.</span><span class="nx">abbrev</span><span class="p">[</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()]</span>
      <span class="nv">b: </span><span class="nf">(date, locale) -&gt;</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">month</span><span class="p">.</span><span class="nx">abbrev</span><span class="p">[</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()]</span>
      <span class="nv">B: </span><span class="nf">(date, locale) -&gt;</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">month</span><span class="p">.</span><span class="nx">full</span><span class="p">[</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()]</span>
      <span class="nv">y: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span>
      <span class="nv">Y: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span>
      <span class="nv">C: </span><span class="nf">(date) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
      <span class="nv">D: </span><span class="nf">(date) -&gt;</span> <span class="nx">tz</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="s2">&quot;%m/%d/%y&quot;</span><span class="p">)</span>
      <span class="nv">x: </span><span class="nf">(date, locale, tzdata) -&gt;</span>
        <span class="nv">utc = </span><span class="nx">convertToUTC</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">tzdata</span><span class="p">)</span>
        <span class="nx">tz</span><span class="p">(</span><span class="nx">utc</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">dateFormat</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">tzdata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
      <span class="nv">F: </span><span class="nf">(date) -&gt;</span> <span class="nx">tz</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-%d&quot;</span><span class="p">)</span>
      <span class="nv">l: </span><span class="nf">(date) -&gt;</span> <span class="nx">dialHours</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span>
      <span class="nv">I: </span><span class="nf">(date) -&gt;</span> <span class="nx">dialHours</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span>
      <span class="nv">k: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">()</span>
      <span class="nv">H: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">()</span>
      <span class="nv">P: </span><span class="nf">(date, locale) -&gt;</span>
        <span class="nx">locale</span><span class="p">.</span><span class="nx">meridiem</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">()</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)]</span>
      <span class="nv">p: </span><span class="nf">(date, locale) -&gt;</span>
        <span class="nx">locale</span><span class="p">.</span><span class="nx">meridiem</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">()</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)].</span><span class="nx">toUpperCase</span><span class="p">()</span>
      <span class="nv">M: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">()</span>
      <span class="nv">s: </span><span class="nf">(date) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
      <span class="nv">S: </span><span class="nf">(date) -&gt;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">()</span>
      <span class="nv">N: </span><span class="nf">(date) -&gt;</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span>
      <span class="nv">r: </span><span class="nf">(date) -&gt;</span> <span class="nx">tz</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="s2">&quot;%I:%M:%S %p&quot;</span><span class="p">)</span>
      <span class="nv">R: </span><span class="nf">(date) -&gt;</span> <span class="nx">tz</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span>
      <span class="nv">T: </span><span class="nf">(date) -&gt;</span> <span class="nx">tz</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
      <span class="nv">X: </span><span class="nf">(date, locale, tzdata) -&gt;</span>
        <span class="nv">utc = </span><span class="nx">convertToUTC</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">tzdata</span><span class="p">)</span>
        <span class="nx">tz</span><span class="p">(</span><span class="nx">utc</span><span class="p">,</span> <span class="nx">tzdata</span><span class="p">),</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">timeFormat</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">tzdata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
      <span class="nv">c: </span><span class="nf">(date, locale, tzdata) -&gt;</span>
        <span class="nv">utc = </span><span class="nx">convertToUTC</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">tzdata</span><span class="p">)</span>
        <span class="nx">tz</span><span class="p">(</span><span class="nx">utc</span><span class="p">,</span> <span class="nx">tzdata</span><span class="p">),</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">dateTimeFormat</span><span class="p">,</span> <span class="nx">locale</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">tzdata</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
      <span class="nv">z: </span><span class="nf">(date, locale, tzdata) -&gt;</span>
        <span class="nv">offset = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">offsetInMilliseconds</span><span class="p">(</span><span class="nx">tzdata</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">offset</span> <span class="o">&lt;</span> <span class="mi">0</span>
          <span class="s2">&quot;-#{pad Math.abs(offset), 4, &quot;</span><span class="mi">0</span><span class="s2">&quot;}&quot;</span>
        <span class="k">else</span>
          <span class="nx">pad</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">offset</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Some format specifiers have padding characters. We specify the padding
counts separately, instead of adding padding in the format specifier
method. Not only does this make it easier to implement the specifiers, the
user can disable padding with modifiers, so it is easier to implement the
toggle if padding is a second step. Thus, we get the number value first,
then pad using the default or user specified padding.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">padding =</span>
      <span class="nv">d: </span><span class="mi">2</span>
      <span class="nv">U: </span><span class="mi">2</span>
      <span class="nv">W: </span><span class="mi">2</span>
      <span class="nv">V: </span><span class="mi">2</span>
      <span class="nv">g: </span><span class="mi">2</span>
      <span class="nv">m: </span><span class="mi">2</span>
      <span class="nv">j: </span><span class="mi">3</span>
      <span class="nv">C: </span><span class="mi">2</span>
      <span class="nv">I: </span><span class="mi">2</span>
      <span class="nv">H: </span><span class="mi">2</span>
      <span class="nv">k: </span><span class="mi">2</span>
      <span class="nv">M: </span><span class="mi">2</span>
      <span class="nv">S: </span><span class="mi">2</span>
      <span class="nv">N: </span><span class="mi">9</span>
      <span class="nv">y: </span><span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Map the padding specifier character to a padding function that will pad
using the specified character. The <code>-</code> specifier means no padding and
overrides the default padding.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">paddings = </span><span class="p">{</span> <span class="s2">&quot;-&quot;</span><span class="o">:</span> <span class="nf">(number) -&gt;</span> <span class="nx">number</span> <span class="p">}</span>
    <span class="k">for</span> <span class="nx">flag</span><span class="p">,</span> <span class="nx">ch</span> <span class="k">of</span> <span class="p">{</span> <span class="s2">&quot;_&quot;</span><span class="o">:</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span> <span class="p">}</span>
      <span class="nx">paddings</span><span class="p">[</span><span class="nx">flag</span><span class="p">]</span> <span class="o">=</span> <span class="nx">do</span> <span class="nf">(ch) -&gt;</span>
        <span class="nf">(number, count) -&gt;</span> <span class="nx">pad</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><em>pad(number, count, char)</em></p>

<p>Pad the given <code>number</code> with the <code>count</code> of the padding <code>char</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">pad = </span><span class="nf">(number, count, char) -&gt;</span>
      <span class="nv">string = </span><span class="nb">String</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span>
      <span class="s2">&quot;#{new Array((count - string.length) + 1).join(char)}#{string}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Map of transformation specifier to a function that will perform the
transformation. Only upcase at the moment.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">transforms =</span>
      <span class="nv">none: </span><span class="nf">(value) -&gt;</span> <span class="nx">value</span>
      <span class="s2">&quot;^&quot;</span><span class="o">:</span> <span class="nf">(value) -&gt;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Implementation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nf">(wallclock, rest, locale, tzdata) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Convert the <code>wallclock</code> seconds since the epoch to a <code>Date</code> to get to
the fields. <code>output</code> will gather our formatted string.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">date    = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">wallclock</span><span class="p">)</span>
      <span class="nv">output  = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>While there is more string to parse.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">while</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Attempt to match format specifier.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">match = </span><span class="sr">///</span>
          <span class="sr">^           </span><span class="c1"># start</span>
          <span class="sr">(.*?)       </span><span class="c1"># non-specifier stuff</span>
          <span class="sr">%           </span><span class="c1"># start specifier</span>
          <span class="sr">(?:</span>
<span class="sr">            %           </span><span class="c1"># literal precent</span>
            <span class="sr">|</span>
<span class="sr">            ([-0_^]?)   </span><span class="c1"># padding</span>
            <span class="sr">(           </span><span class="c1"># field</span>
              <span class="sr">[aAcdDeFHIjklMNpPsrRSTuwXUWVmhbByYcGgCx]</span>
<span class="sr">            )</span>
<span class="sr">          )</span>
<span class="sr">          (.*)        </span><span class="c1"># rest</span>
          <span class="sr">$           </span><span class="c1"># end</span>
        <span class="sr">///</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">rest</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>If we match, then replace the specifier with the formatted date field.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">match</span>
          <span class="p">[</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">specifier</span><span class="p">,</span> <span class="nx">rest</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>We have a specifier.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">specifier</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Get out specifier field value.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">value = </span><span class="nx">specifiers</span><span class="p">[</span><span class="nx">specifier</span><span class="p">](</span><span class="nx">date</span><span class="p">,</span> <span class="nx">locale</span><span class="p">,</span> <span class="nx">tzdata</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Apply padding, if the specifier is padded. The <code>k</code> specifier is
padded with spaces, but all others are padded with zeros. We apply
the user override, if any, and call the appropriate padding
function.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">padding</span><span class="p">[</span><span class="nx">specifier</span><span class="p">]</span>
              <span class="nv">style = </span><span class="k">if</span> <span class="nx">specifier</span> <span class="o">is</span> <span class="s2">&quot;k&quot;</span> <span class="k">then</span> <span class="s2">&quot;_&quot;</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span>
              <span class="k">if</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">length</span>
                <span class="nv">style = </span><span class="nx">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">paddings</span><span class="p">[</span><span class="nx">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
              <span class="nv">value = </span><span class="nx">paddings</span><span class="p">[</span><span class="nx">style</span><span class="p">](</span><span class="nx">value</span><span class="p">,</span> <span class="nx">padding</span><span class="p">[</span><span class="nx">specifier</span><span class="p">],</span> <span class="nx">tzdata</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Apply any user specified transformations. This is only upper case,
and it implies that the value is not numeric, there is never more
than one modifier.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">transform = </span><span class="nx">transforms</span><span class="p">.</span><span class="nx">none</span>
            <span class="k">if</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">length</span>
              <span class="nv">transform = </span><span class="nx">transforms</span><span class="p">[</span><span class="nx">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">or</span> <span class="nx">transform</span>
            <span class="nv">value = </span><span class="nx">transform</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Add the prefix and converted value to the output.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">prefix</span> <span class="k">if</span> <span class="nx">prefix</span><span class="o">?</span>
            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>We have a literal percent.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">else</span>
            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;%&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Otherwise, we're going to be done with this loop.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">length</span>
          <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">rest</span>
          <span class="nv">rest = </span><span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Gather up our output into a string.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">output</span><span class="p">.</span><span class="nx">join</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Create a date, filling in the blanks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeDate = </span><span class="nx">do</span> <span class="o">-&gt;</span>
    <span class="nv">zeroUnless = </span><span class="nf">(date, value) -&gt;</span>
      <span class="k">if</span> <span class="nx">value</span><span class="o">?</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="nb">parseInt</span> <span class="nx">value</span><span class="p">,</span> <span class="mi">10</span>
      <span class="k">else</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="mi">0</span>

    <span class="nf">(year, month, day, hours, minutes, seconds, milliseconds) -&gt;</span>
      <span class="nv">date = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>No year, and we have a time with no date, so we use todays date.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">year</span><span class="o">?</span>
        <span class="nv">now = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="nb">parseInt</span> <span class="nx">year</span><span class="p">,</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>No month? If we have no year, and we have a time with no date, so
we use todays date. If we have a year, then we have a date with no
month, so we assume January.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">month</span><span class="o">?</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">year</span><span class="o">?</span>
          <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="mi">0</span>
      <span class="k">else</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">month</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>No day? If we have no year, and we have a time with no date, so we use
todays date. If we have a year, then we have a date with no day, so we
assume the first of the month.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">day</span><span class="o">?</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">year</span><span class="o">?</span>
          <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="mi">1</span>
      <span class="k">else</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">push</span> <span class="nb">parseInt</span> <span class="nx">day</span><span class="p">,</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>For hours, minutes, seconds, and milliseconds, if they are not
specified, then they are zero.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">zeroUnless</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">hours</span>
      <span class="nx">zeroUnless</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">minutes</span>
      <span class="nx">zeroUnless</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">seconds</span>
      <span class="nx">zeroUnless</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">milliseconds</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Return wallclock millseconds since the epoch.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">date</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Parse a date, possibly fuzzy.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parse = </span><span class="nf">(pattern) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Best foot forward, an ISO date. An ISO date can also be YYYY, but we catch
that case later on, so we don't pluck YYYY/MM or some such now.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nv">match = </span><span class="sr">///</span>
      <span class="sr">^             </span><span class="c1"># start</span>
      <span class="sr">(.*?)         </span><span class="c1"># before</span>
      <span class="sr">(?:           </span><span class="c1"># year </span>
        <span class="sr">(\d\d\d\d)    </span><span class="c1"># four digit year</span>
          <span class="sr">-           </span><span class="c1"># hyphen</span>
        <span class="sr">(\d\d)        </span><span class="c1"># two digit month</span>
        <span class="sr">(?:           </span><span class="c1"># optional date</span>
            <span class="sr">-           </span><span class="c1"># hypen</span>
          <span class="sr">(\d{2})       </span><span class="c1"># two digit date</span>
        <span class="sr">)?</span>
<span class="sr">      |             </span><span class="c1"># year with no hyphens</span>
        <span class="sr">(\d{4})       </span><span class="c1"># year</span>
        <span class="sr">(\d{2})       </span><span class="c1"># month</span>
        <span class="sr">(\d{2})?      </span><span class="c1"># date</span>
      <span class="sr">)</span>
<span class="sr">      (?:           </span><span class="c1"># optional time</span>
        <span class="sr">(?:\s+|T)     </span><span class="c1"># time delimiter</span>
        <span class="sr">(\d\d)        </span><span class="c1"># hours</span>
        <span class="sr">(?:           </span><span class="c1"># optional minutes</span>
          <span class="sr">:?            </span><span class="c1"># optional colon</span>
          <span class="sr">(\d\d)        </span><span class="c1"># minutes </span>
          <span class="sr">(?:           </span><span class="c1"># optional seconds</span>
            <span class="sr">:?            </span><span class="c1"># optional colon</span>
            <span class="sr">(\d\d)        </span><span class="c1"># seconds</span>
            <span class="sr">(?:           </span><span class="c1"># optional milliseconds</span>
              <span class="sr">\.            </span><span class="c1"># period</span>
              <span class="sr">(\d+)         </span><span class="c1"># milliseconds</span>
            <span class="sr">)?</span>
<span class="sr">          )?</span>
<span class="sr">        )?</span>
<span class="sr">      )?</span>
<span class="sr">      (?:           </span><span class="c1"># optional zone </span>
        <span class="sr">(?:\s+|Z)     </span><span class="c1"># zone delimiter</span>
        <span class="sr">(?:</span>
<span class="sr">          ([+-])      </span><span class="c1"># sign</span>
          <span class="sr">(\d{2})     </span><span class="c1"># hours</span>
          <span class="sr">(?:         </span><span class="c1"># optional minutes</span>
            <span class="sr">:?          </span><span class="c1"># optional colon</span>
            <span class="sr">(\d{2})     </span><span class="c1"># minutes</span>
          <span class="sr">)?</span>
<span class="sr">        )</span>
<span class="sr">      )?</span>
<span class="sr">      (.*)          </span><span class="c1"># after</span>
      <span class="sr">$</span>
<span class="sr">    ///</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Stuff before the matched ISO date.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">before = </span><span class="nx">match</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span>
      </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>See if we matched the hyphenated date.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">date = </span><span class="nx">match</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
      <span class="p">[</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">,</span> <span class="nx">day</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">date</span> <span class="k">if</span> <span class="nx">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>See if we matched the all numbers date.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">date = </span><span class="nx">match</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
      <span class="p">[</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">,</span> <span class="nx">day</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">date</span> <span class="k">if</span> <span class="nx">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>See if we matched the a time.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">time = </span><span class="nx">match</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
      <span class="p">[</span> <span class="nx">hours</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">,</span> <span class="nx">milliseconds</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">time</span> <span class="k">if</span> <span class="nx">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>See if we matched a zone offset.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">zone = </span><span class="nx">match</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
      <span class="p">[</span> <span class="nx">sign</span><span class="p">,</span> <span class="nx">zoneHours</span><span class="p">,</span> <span class="nx">zoneMinutes</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">zone</span> <span class="k">if</span> <span class="nx">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Stuff fater the matched ISO date.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">after = </span><span class="nx">match</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>If we nailed it, let's stop here.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">remaining = </span><span class="p">(</span><span class="nx">before</span> <span class="o">+</span> <span class="nx">after</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">length</span>
      <span class="k">if</span> <span class="nx">remaining</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nx">makeDate</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">,</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">hours</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">,</span> <span class="nx">milliseconds</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Parse a UNIX date, another common construct. No need to be fuzzy about
this at all. There is only really one valid format.</p>             </td>             <td class="code">               <div class="highlight"><pre>   </pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Try to find something date like, interpret using locale.</p>             </td>             <td class="code">               <div class="highlight"><pre>   </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Take the locale preference for month/day ordering.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>If it doesn't fit, try the other way.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>If that doesn't fit, see if you can find a date in the remaining bit.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Look for a time, either in the whole pattern, or in what's left after the
date consumed a date-like thing.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Now let's split what we've got and look for locale specific words that are
meaningful.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>If we're willing to be fuzzy, then we'll look harder. Maybe we have a
bunch of regular expressions to run, that will extract locale specific
strings, say, this looks like an hour, this looks like a day of the week,
this looks like a date. So /at (\d+)\s*([pa]m?)/i or some such, with ()
for place holders for bits of the pattern that won't match.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Let's start by parsing ISO, UNIX and not very fuzzy dates. Really, you can
just tell the user to try harder, or else prompt with a date format.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h4>offsetInMilliseconds(pattern)</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Convert offset, read from our time zone database, or from an ISO date, into
milliseconds so we can use it to adjust milliseconds since the epoch.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">offsetInMilliseconds = </span><span class="nf">(pattern) -&gt;</span>
    <span class="nv">match = </span><span class="sr">/^(-?)(\d)+(?::(\d)+)?(?::(\d+))?$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">pattern</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;1&quot;</span>
    <span class="p">[</span> <span class="nx">sign</span><span class="p">,</span> <span class="nx">hours</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">seconds</span> <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
      <span class="nb">parseInt</span><span class="p">(</span><span class="nx">number</span> <span class="o">or</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="nx">number</span> <span class="k">in</span> <span class="nx">match</span>
    <span class="p">)</span>
    <span class="nv">offset  = </span><span class="nx">hours</span>   <span class="o">*</span> <span class="nx">HOUR</span>
    <span class="nx">offset</span> <span class="o">+=</span> <span class="nx">minutes</span> <span class="o">*</span> <span class="nx">MINUTE</span>
    <span class="nx">offset</span> <span class="o">+=</span> <span class="nx">seconds</span> <span class="o">*</span> <span class="nx">SECOND</span>
    <span class="nx">offset</span> <span class="o">*=</span> <span class="nx">sign</span>
    <span class="nx">offset</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <h4>ruleToEpoch(year, rule)</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Convert a daylight savings time rule into miliseconds since the epoch. We
use <code>Date</code> because it gives us the day of the week. No error checking on
rule, it is assumed to be correct in the database. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ruleToDate = </span><span class="nf">(year, rule) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Split up the time of day.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">match = </span><span class="sr">/^(\d)+:(\d)+(?::(\d+))?$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">time</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">[</span> <span class="nx">hours</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">seconds</span> <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">parseInt</span> <span class="nx">number</span> <span class="o">or</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span> <span class="k">for</span> <span class="nx">number</span> <span class="k">in</span> <span class="nx">match</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Split up the daylight savings time day.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">match = </span><span class="sr">///</span>
      <span class="sr">^             </span><span class="c1"># start</span>
      <span class="sr">(?:</span>
<span class="sr">        (\d+)         </span><span class="c1"># a fixed date</span>
        <span class="sr">|</span>
<span class="sr">        last(\w+)     </span><span class="c1"># last day of month</span>
        <span class="sr">|</span>
<span class="sr">        (\w+)&gt;=(\d+)  </span><span class="c1"># day greater than or equal to date</span>
      <span class="sr">)</span>
<span class="sr">      $             </span><span class="c1"># end</span>
    <span class="sr">///</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">day</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>A fixed date.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="p">[</span> <span class="nx">month</span><span class="p">,</span> <span class="nx">day</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">month</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="p">]</span>
      <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">,</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">hours</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Last of a particular day of the week in the month.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">LOCALES</span><span class="p">.</span><span class="nx">en_US</span><span class="p">.</span><span class="nx">day</span><span class="p">.</span><span class="nx">abbrev</span>
        <span class="k">if</span> <span class="nx">day</span> <span class="o">is</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
          <span class="nv">index = </span><span class="nx">i</span>
          <span class="k">break</span>
      <span class="nv">day = </span><span class="nx">daysInMonth</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">month</span><span class="p">,</span> <span class="nx">year</span><span class="p">)</span>
      <span class="nx">loop</span>
        <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">month</span><span class="p">,</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">hours</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDay</span><span class="p">()</span> <span class="o">is</span> <span class="nx">index</span>
          <span class="k">break</span>
        <span class="nx">day</span><span class="o">--</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>A day of the week greater than or equal to a day of the month.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nv">min = </span><span class="nb">parseInt</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">10</span>
      <span class="k">for</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">LOCALES</span><span class="p">.</span><span class="nx">en_US</span><span class="p">.</span><span class="nx">day</span><span class="p">.</span><span class="nx">abbrev</span>
        <span class="k">if</span> <span class="nx">day</span> <span class="o">is</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
          <span class="nv">index = </span><span class="nx">i</span>
          <span class="k">break</span>
      <span class="nv">day = </span><span class="mi">1</span>
      <span class="nx">loop</span>
        <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">month</span><span class="p">,</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">hours</span><span class="p">,</span> <span class="nx">minutes</span><span class="p">,</span> <span class="nx">seconds</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDay</span><span class="p">()</span> <span class="o">is</span> <span class="nx">index</span> <span class="o">and</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nx">min</span>
          <span class="k">break</span>
        <span class="nx">day</span><span class="o">++</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Return wallclock milliseconds since the epoch.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Parse until. We store until as a string in the JSON zone files so they are
easy to read. If IE 6 supports parsing ISO date stamps, we can use <code>new
Date(zone.until)</code> instead of the regex.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">convertUntil = </span><span class="nf">(zone) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">zone</span><span class="p">.</span><span class="nx">until</span> <span class="o">isnt</span> <span class="s2">&quot;number&quot;</span>
      <span class="k">if</span> <span class="nx">zone</span><span class="p">.</span><span class="nx">until</span><span class="o">?</span>
        <span class="nv">fields = </span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">field</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="nx">field</span> <span class="k">in</span> <span class="sr">///</span>
          <span class="sr">^</span>
<span class="sr">          (\d{4})-(\d{2})-(\d{2})</span>
<span class="sr">          T</span>
<span class="sr">          (\d{2}):(\d{2}):(\d{2})</span>
<span class="sr">          .000Z</span>
<span class="sr">          $</span>
<span class="sr">        ///</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">zone</span><span class="p">.</span><span class="nx">until</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="nx">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">--</span>
        <span class="nv">zone.until = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">fields</span>
      <span class="k">else</span>
        <span class="nv">zone.until = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">MAX_VALUE</span>
    <span class="nx">zone</span><span class="p">.</span><span class="nx">until</span>
      </pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Convert the UTC epoch seconds to epoch seconds in the given time zone.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">convertToWallclock = </span><span class="nf">(utc, tzdata) -&gt;</span>
    <span class="k">for</span> <span class="nx">maybe</span> <span class="k">in</span> <span class="nx">tzdata</span>
      <span class="nv">offset = </span><span class="nx">utc</span> <span class="o">+</span> <span class="nx">offsetInMilliseconds</span><span class="p">(</span><span class="nx">maybe</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span>
      <span class="k">break</span> <span class="k">if</span> <span class="nx">convertUntil</span><span class="p">(</span><span class="nx">maybe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">offset</span>
      <span class="nv">zone = </span><span class="nx">maybe</span>
      <span class="nv">wall = </span><span class="nx">offset</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Now we have an adjusted time. We're going to pretend that seconds since
the epoch starts from 1/1/1970 in the current timezone, instead of in
UTC. We're going to use our date a structure for the field names, and
treat UTC values as if the were local time. This means we can do simple
compares between seconds since the epoch, but this is our little secret.</p>

<p>FIXME We use this three times. DRY it up.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nv">rules = </span><span class="nx">TIMEZONES</span><span class="p">.</span><span class="nx">rules</span><span class="p">[</span><span class="nx">zone</span><span class="p">.</span><span class="nx">rules</span><span class="p">]</span>
        <span class="nv">year = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">wall</span><span class="p">).</span><span class="nx">getUTCFullYear</span><span class="p">()</span>
        <span class="nv">previous = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span>
        <span class="k">for</span> <span class="nx">rule</span> <span class="k">in</span> <span class="nx">rules</span>
          <span class="k">if</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">year</span> <span class="o">and</span> <span class="nx">year</span> <span class="o">&lt;=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">to</span>
            <span class="nv">start = </span><span class="nx">ruleToDate</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">rule</span><span class="p">)</span>
            <span class="nv">offsetWall = </span><span class="nx">wall</span>
            <span class="nx">offsetWall</span> <span class="o">+=</span> <span class="nx">offsetInMilliseconds</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">save</span><span class="p">)</span> <span class="k">if</span> <span class="nx">dst</span>
            <span class="k">if</span> <span class="nx">start</span> <span class="o">&lt;=</span> <span class="nx">offsetWall</span> <span class="o">and</span> <span class="nx">previous</span> <span class="o">&lt;</span> <span class="nx">start</span>
              <span class="nv">previous = </span><span class="nx">start</span>
              <span class="nv">dst = </span><span class="nx">rule</span>

    <span class="nx">wall</span> <span class="o">+=</span> <span class="nx">offsetInMilliseconds</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">save</span><span class="p">)</span> <span class="k">if</span> <span class="nx">dst</span>

    <span class="nx">wall</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Convert from a wallclock milliseconds since the epoch to UTC milliseconds
since the epoch.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">convertToUTC = </span><span class="nf">(wallclock, tzdata) -&gt;</span>
    <span class="k">for</span> <span class="nx">maybe</span> <span class="k">in</span> <span class="nx">tzdata</span>
      <span class="k">break</span> <span class="k">if</span> <span class="nx">convertUntil</span><span class="p">(</span><span class="nx">maybe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">wallclock</span>
      <span class="nv">zone = </span><span class="nx">maybe</span>

      <span class="k">if</span> <span class="nv">rules = </span><span class="nx">TIMEZONES</span><span class="p">.</span><span class="nx">rules</span><span class="p">[</span><span class="nx">zone</span><span class="p">.</span><span class="nx">rules</span><span class="p">]</span>
        <span class="nv">year = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">wallclock</span><span class="p">).</span><span class="nx">getUTCFullYear</span><span class="p">()</span>
        <span class="nv">previous = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span>
        <span class="k">for</span> <span class="nx">rule</span> <span class="k">in</span> <span class="nx">rules</span>
          <span class="k">if</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">year</span> <span class="o">and</span> <span class="nx">year</span> <span class="o">&lt;=</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">to</span>
            <span class="nv">start = </span><span class="nx">ruleToDate</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">rule</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">start</span> <span class="o">&lt;=</span> <span class="nx">wallclock</span> <span class="o">and</span> <span class="nx">previous</span> <span class="o">&lt;</span> <span class="nx">start</span>
              <span class="nv">previous = </span><span class="nx">start</span>
              <span class="nv">dst = </span><span class="nx">rule</span>

    <span class="nv">utc = </span><span class="nx">wallclock</span> <span class="o">-</span> <span class="nx">offsetInMilliseconds</span><span class="p">(</span><span class="nx">zone</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">dst</span> <span class="o">and</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">save</span> <span class="o">isnt</span> <span class="s1">&#39;0&#39;</span>
      <span class="nx">utc</span> <span class="o">-=</span> <span class="nx">offsetInMilliseconds</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">save</span><span class="p">)</span>

    <span class="nx">utc</span>

  <span class="nv">adjust = </span><span class="nx">do</span> <span class="o">-&gt;</span>
    <span class="nv">FIELD =</span>
      <span class="nv">year: </span>  <span class="mi">0</span>
      <span class="nv">month: </span> <span class="mi">1</span>
      <span class="nv">day: </span>   <span class="mi">2</span>
      <span class="nv">hour: </span>  <span class="mi">3</span>
      <span class="nv">minute: </span><span class="mi">4</span>
      <span class="nv">second: </span><span class="mi">5</span>
      <span class="nv">milli: </span> <span class="mi">6</span>

    <span class="nv">SIGN_OFFSET =</span>
      <span class="s2">&quot;-&quot;</span><span class="o">:</span>  <span class="o">-</span><span class="mi">1</span>
      <span class="s2">&quot;+&quot;</span><span class="o">:</span>  <span class="o">+</span><span class="mi">1</span>

    <span class="nv">explode = </span><span class="nf">(wallclock) -&gt;</span>

    <span class="nf">(wallclock, adjustment, tzdata) -&gt;</span>
      <span class="nv">fields = </span><span class="nx">explode</span> <span class="nx">wallclock</span>
      <span class="nv">offsets = </span><span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span>
      <span class="nv">rest = </span><span class="nx">adjustment</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="nx">loop</span>
        <span class="nv">match = </span><span class="sr">///</span>
          <span class="sr">^                 </span><span class="c1"># start</span>
          <span class="sr">([+-])            </span><span class="c1"># add or subtract</span>
          <span class="sr">\s*               </span><span class="c1"># optional space</span>
          <span class="sr">(\d+)             </span><span class="c1"># count</span>
          <span class="sr">\s+               </span><span class="c1"># manditory space</span>
          <span class="sr">( year            </span><span class="c1"># unit</span>
          <span class="sr">| month</span>
<span class="sr">          | day</span>
<span class="sr">          | hour</span>
<span class="sr">          | minute</span>
<span class="sr">          | second</span>
<span class="sr">          | milli</span>
<span class="sr">          )</span>
<span class="sr">          s?                </span><span class="c1"># optional plural</span>
          <span class="sr">(:?               </span><span class="c1"># either</span>
            <span class="sr">(?:</span>
<span class="sr">              \s+               </span><span class="c1"># space delimiter</span>
              <span class="sr">(.*)              </span><span class="c1"># rest of pattern</span>
            <span class="sr">)               </span><span class="c1"># or </span>
            <span class="sr">|</span>
<span class="sr">            (.*)            </span><span class="c1"># terminal pattern or garbage</span>
          <span class="sr">)</span>
<span class="sr">          $                 </span><span class="c1"># end</span>
        <span class="sr">///</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">rest</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">match</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;bad date math pattern #{adjustment}.&quot;</span>
        <span class="p">[</span> <span class="nx">sign</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">unit</span><span class="p">,</span> <span class="nx">rest</span><span class="p">,</span> <span class="nx">terminal</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nx">terminal</span><span class="o">?</span>
          <span class="k">if</span> <span class="nx">terminal</span> <span class="o">isnt</span> <span class="s2">&quot;&quot;</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;bad date math pattern #{adjustment}.&quot;</span>
          <span class="k">break</span>
        <span class="nx">offsets</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">[</span><span class="nx">unit</span><span class="p">]]</span> <span class="o">+=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="nx">SIGN_OFFSET</span><span class="p">[</span><span class="nx">sign</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">rest</span> <span class="o">is</span> <span class="s2">&quot;&quot;</span>
          <span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Hourly math in UTC.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">utc = </span><span class="nx">convertToUTC</span> <span class="nx">wallclock</span><span class="p">,</span> <span class="nx">tzdata</span>

      <span class="nx">utc</span> <span class="o">+=</span> <span class="nx">offsets</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">milli</span><span class="p">]</span>
      <span class="nx">utc</span> <span class="o">+=</span> <span class="nx">offsets</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">second</span><span class="p">]</span>  <span class="o">*</span> <span class="nx">SECOND</span>
      <span class="nx">utc</span> <span class="o">+=</span> <span class="nx">offsets</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">minute</span><span class="p">]</span>  <span class="o">*</span> <span class="nx">MINUTE</span>
      <span class="nx">utc</span> <span class="o">+=</span> <span class="nx">offsets</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">hour</span><span class="p">]</span>    <span class="o">*</span> <span class="nx">HOUR</span>
 </pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Day to day math in wallclock time.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">wallclock = </span><span class="nx">convertToWallclock</span> <span class="nx">utc</span><span class="p">,</span> <span class="nx">tzdata</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Accounts for leap years and days of month.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">wallclock</span> <span class="o">+=</span> <span class="nx">offsets</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">day</span><span class="p">]</span> <span class="o">*</span> <span class="nx">DAY</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Explode into individual fields for month and year math.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">wallclock</span><span class="p">)</span>
      <span class="nv">fields = </span><span class="p">[</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">()</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">()</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">()</span>
        <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">()</span>
      <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>It is easier to move through the months ourselves that it is to move by
milliseconds.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nv">offset = </span><span class="nx">offsets</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">month</span><span class="p">]</span>
        <span class="nv">increment = </span><span class="nx">offset</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>
        <span class="k">while</span> <span class="nx">offset</span> <span class="o">isnt</span> <span class="mi">0</span>
          <span class="nv">month = </span><span class="nx">offset</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">month</span><span class="p">]</span>
          <span class="k">if</span> <span class="nx">month</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">offset</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="nx">fields</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">month</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span>
            <span class="nx">fields</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">year</span><span class="p">]</span><span class="o">--</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">month</span> <span class="o">is</span> <span class="mi">11</span> <span class="o">and</span> <span class="nx">offset</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nx">fields</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">month</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nx">fields</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">year</span><span class="p">]</span><span class="o">++</span>
          <span class="k">else</span>
            <span class="nx">fields</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">month</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">increment</span>
          <span class="nx">offset</span> <span class="o">+=</span> <span class="nx">increment</span>
          </pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Adjust the year. </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">fields</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">year</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">offsets</span><span class="p">[</span><span class="nx">FIELD</span><span class="p">.</span><span class="nx">year</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Create a wallclock date.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">fields</span>
       </pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>The all purpose exported function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.tz = tz = </span><span class="nf">(date, splat...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Assert that we've been given a date.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;invalid arguments&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">date</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Create a default request.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">request = </span><span class="p">{</span> <span class="nv">adjustments: </span><span class="p">[]</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Arguments with a "%" are date formats. Arguments that match a timezone are
timezones, while arguments that look like locales are locales. If nothing
matches, we assume that it is date math.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">argument</span> <span class="k">in</span> <span class="nx">splat</span>
      <span class="nv">argument = </span><span class="nb">String</span><span class="p">(</span><span class="nx">argument</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">argument</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">format</span> <span class="o">or=</span> <span class="nx">argument</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">TIMEZONES</span><span class="p">.</span><span class="nx">zones</span><span class="p">[</span><span class="nx">argument</span><span class="p">]</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">zone</span> <span class="o">or=</span> <span class="nx">argument</span>
      <span class="k">else</span> <span class="k">if</span> <span class="sr">/^\w{2}_\w{2}$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">argument</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;unknown locale&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">LOCALES</span><span class="p">[</span><span class="nx">argument</span><span class="p">]</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">locale</span> <span class="o">or=</span> <span class="nx">argument</span>
      <span class="k">else</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">adjustments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">argument</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Home of the the author is the default locale for no good reason.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">request</span><span class="p">.</span><span class="nx">locale</span> <span class="o">or=</span> <span class="s2">&quot;en_US&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>UTC is the default time zone for good reason.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">request</span><span class="p">.</span><span class="nx">zone</span> <span class="o">or=</span> <span class="s2">&quot;UTC&quot;</span>
    
    <span class="nv">request.tzdata = </span><span class="nx">TIMEZONES</span><span class="p">.</span><span class="nx">zones</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">zone</span><span class="p">]</span>
    <span class="nv">request.locale = </span><span class="nx">LOCALES</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">locale</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Convert the date argument to seconds since the epoch. The seconds since
the epoch is really way to have a record used to store date fields. The
fields are accessed by converting the epoch into a Date object. The zone
offset field values of the converted object are meaningless and the UTC
offset field values represent our working time zone.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">date</span> <span class="o">is</span> <span class="s2">&quot;string&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Parse will apply the time zone offset.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">wallclock = </span><span class="nx">parse</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">request</span>

    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Convert from date to epoch seconds if necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">wallclock = </span><span class="k">if</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span> <span class="k">then</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="k">else</span> <span class="nx">date</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Offset by time zone if not UTC.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">zone</span> <span class="o">isnt</span> <span class="s2">&quot;UTC&quot;</span>
        <span class="nv">wallclock = </span><span class="nx">convertToWallclock</span> <span class="nx">wallclock</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tzdata</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Apply date math if any.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">adjustment</span> <span class="k">in</span> <span class="nx">request</span><span class="p">.</span><span class="nx">adjustments</span>
      <span class="nv">wallclock = </span><span class="nx">adjust</span> <span class="nx">wallclock</span><span class="p">,</span> <span class="nx">adjustment</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tzdata</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Apply format if any. The record is adjusted to the current timezone for
use as a date/time field record.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">format</span>
      <span class="nv">token = </span><span class="nx">format</span> <span class="nx">wallclock</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">format</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">locale</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tzdata</span>
  </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Otherwise convert back to UTC if not already UTC.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">zone</span> <span class="o">isnt</span> <span class="s2">&quot;UTC&quot;</span>
      <span class="nv">token = </span><span class="nx">convertToUTC</span> <span class="nx">wallclock</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">tzdata</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Otherwise the seconds since the epoch are already in UTC.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nv">token = </span><span class="nx">wallclock</span>

    <span class="nx">token</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Add or replace locales with the given locale data structure. If a locale in
the data structure already exists, the locale is overwritten.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tz.locales = </span><span class="nf">(override) -&gt;</span>
    <span class="k">if</span> <span class="nx">override</span><span class="o">?</span>
      <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">override</span>
        <span class="nx">LOCALES</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
    <span class="nx">LOCALES</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Add or replace time zones with the given locale data structure. If a time
zone in the data structure already exists, the time zone is overwritten.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tz.timezones = </span><span class="nf">(override) -&gt;</span>
    <span class="k">if</span> <span class="nx">override</span><span class="o">?</span><span class="p">.</span><span class="nx">zones</span><span class="o">?</span>
      <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">override</span><span class="p">.</span><span class="nx">zones</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Set the timezone. Also record the time zone name in the time zone
array object here, because can't put it in the JSON time zone files.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">TIMEZONES</span><span class="p">.</span><span class="nx">zones</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
        <span class="nx">TIMEZONES</span><span class="p">.</span><span class="nx">zones</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nv">name = </span><span class="nx">k</span>
      <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">override</span><span class="o">?</span><span class="p">.</span><span class="nx">rules</span>
        <span class="nx">TIMEZONES</span><span class="p">.</span><span class="nx">rules</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
    <span class="nx">TIMEZONES</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 